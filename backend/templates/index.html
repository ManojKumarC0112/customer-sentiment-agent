<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SentimentAI App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg-color-dark: #1f2024; --text-color-dark: #e0e0e0; --accent-color-dark: #FF8800; --input-bg-dark: #2e2f34;
    --bg-color-light: #f4f7f9; --text-color-light: #222222; --accent-color-light: #d97706; --input-bg-light: #ffffff;
  }
  html[data-theme="dark"] { --bg-color: var(--bg-color-dark); --text-color: var(--text-color-dark); --accent-color: var(--accent-color-dark); --input-bg: var(--input-bg-dark); }
  html[data-theme="light"] { --bg-color: var(--bg-color-light); --text-color: var(--text-color-light); --accent-color: var(--accent-color-light); --input-bg: var(--input-bg-light); }
  body { margin: 0; background-color: var(--bg-color); color: var(--text-color); font-family: 'Poppins', Arial, sans-serif; min-height: 100vh; transition: background-color 0.3s ease, color 0.3s ease; }
  header { background: var(--input-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; height: 60px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .brand-logo { font-weight: 700; font-size: 1.5rem; color: var(--accent-color); user-select: none; text-transform: uppercase; text-decoration: none; }
  nav { display: flex; gap: 1.5rem; font-weight: 600; }
  nav a { color: var(--text-color); text-decoration: none; padding-bottom: 5px; border-bottom: 3px solid transparent; transition: border-color 0.25s ease; cursor: pointer; }
  nav a:hover, nav a[aria-current="page"] { border-bottom: 3px solid var(--accent-color); color: var(--accent-color); }
  .header-actions { display: flex; align-items: center; gap: 1rem; }
  .theme-toggle { background: none; border: 2px solid var(--accent-color); border-radius: 50%; width: 40px; height: 40px; color: var(--accent-color); cursor: pointer; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; user-select: none; }
  .profile-menu { position: relative; }
  .profile-btn { cursor: pointer; background: var(--input-bg); border: 2px solid var(--accent-color); border-radius: 20px; padding: 0.4rem 1rem; color: var(--accent-color); font-weight: 600; user-select: none; white-space: nowrap; text-transform: capitalize; }
  .profile-dropdown { position: absolute; top: 48px; right: 0; background: var(--input-bg); border: 1px solid var(--accent-color); border-radius: 12px; width: 140px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); display: none; z-index: 1000; user-select: none; overflow: hidden; }
  .profile-dropdown button { width: 100%; background: none; border: none; color: var(--text-color); padding: 12px 1rem; font-weight: 600; cursor: pointer; text-align: left; }
  .profile-dropdown button:hover { background-color: var(--accent-color); color: white; }
  main { max-width: 600px; margin: 3rem auto; background: var(--input-bg); border-radius: 16px; padding: 2.5rem; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
  .greeting { font-size: 1.6rem; font-weight: 700; margin-bottom: 1rem; text-align: center; color: var(--accent-color); }
  .domain-dropdown-container { margin: 1.5rem 0; text-align: center; }
  .domain-dropdown-container label { font-weight: 600; color: var(--text-color); display: block; margin-bottom: 0.5rem; }
  .domain-dropdown-container select { padding: 0.7rem 1rem; border-radius: 12px; border: 1px solid #555; background: var(--bg-color); color: var(--text-color); font-weight: 600; font-size: 1.1rem; }
  .card label { display: block; width: 100%; margin-top: 0.8rem; font-weight:600; }
  .card input, .card select { margin-bottom: 1.2rem; border-radius: 8px; border: 1px solid #555; background: var(--bg-color); color: var(--text-color); padding: 0.7rem 1rem; font-size: 1rem; width:100%; box-sizing:border-box; }
  .card .submit-btn { background-color: var(--accent-color); border: none; color: white; font-weight: 700; border-radius: 8px; font-size: 1.1rem; padding: 0.75rem 2rem; cursor: pointer; margin-top: 1rem; width: 100%; }
  .card .submit-btn:hover { opacity: 0.9; }
  .auth-toggle { background: none; border: none; color: var(--accent-color); text-decoration: underline; cursor: pointer; margin-top: 1rem; font-size: 0.95rem; }
  .two-column { display: flex; gap: 1rem; }
  .error { color: #ef4444; margin-top: -0.8rem; margin-bottom: 1rem; min-height: 1.2em; font-weight:600; }
</style>
</head>
<body>
<header>
  <a href="/" class="brand-logo">SentimentAI</a>
  <nav>
    <a href="/" class="nav-link" aria-current="page">Home</a>
    <a href="/upload" class="nav-link">Upload</a>
    <a href="/about" class="nav-link">About</a>
    <a href="/metrics" class="nav-link">Metrics</a>
  </nav>
  <div class="header-actions">
    <button class="theme-toggle" id="toggleTheme">🌙</button>
    <div class="profile-menu" id="profileMenuContainer"></div>
  </div>
</header>
<main id="mainContent"></main>

<script>
  const themeToggle = document.getElementById('toggleTheme');
  const profileMenuContainer = document.getElementById('profileMenuContainer');
  const mainContent = document.getElementById('mainContent');
  const domains = ['General', 'Banking', 'Healthcare', 'E-Commerce'];
  let user = null;
  let mode = 'login';

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    themeToggle.textContent = theme === 'dark' ? '🌙' : '☀️';
  }
  themeToggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    setTheme(current === 'dark' ? 'light' : 'dark');
  });
  setTheme(localStorage.getItem('theme') || 'dark');

  function isUserValid(u) { return u && u.email && u.name; }

  function updateProfileMenu() {
    user = JSON.parse(localStorage.getItem('user'));
    if (isUserValid(user)) {
      profileMenuContainer.innerHTML = `
        <button id="profileBtn" class="profile-btn" aria-haspopup="true" aria-expanded="false">${user.name} ▼</button>
        <div class="profile-dropdown" id="profileDropdown">
          <button id="logoutBtn">Logout</button>
        </div>`;
      const profileBtn = document.getElementById('profileBtn');
      const profileDropdown = document.getElementById('profileDropdown');
      profileBtn.onclick = () => {
        const isExpanded = profileBtn.getAttribute('aria-expanded') === 'true';
        profileDropdown.style.display = isExpanded ? 'none' : 'block';
        profileBtn.setAttribute('aria-expanded', !isExpanded);
      };
      document.getElementById('logoutBtn').onclick = () => {
        localStorage.removeItem('user');
        window.location.href = '/login'; // Corrected redirect
      };
      document.addEventListener('click', (e) => {
        if (!profileMenuContainer.contains(e.target)) {
          if (document.getElementById('profileDropdown')) {
            document.getElementById('profileDropdown').style.display = 'none';
            document.getElementById('profileBtn').setAttribute('aria-expanded', 'false');
          }
        }
      });
    } else {
      profileMenuContainer.innerHTML = '';
    }
  }

  function domainSelectorHTML() {
    const currentDomain = localStorage.getItem('selectedDomain') || domains[0].toLowerCase();
    return `<div class="domain-dropdown-container">
        <label for="domainSelect">Select Your Active Domain</label>
        <select id="domainSelect">${domains.map(d => `<option value="${d.toLowerCase()}" ${d.toLowerCase() === currentDomain ? 'selected' : ''}>${d}</option>`).join('')}</select>
      </div>`;
  }

  function showLanding() {
    user = JSON.parse(localStorage.getItem('user'));
    mainContent.innerHTML = `
      <div class="greeting">Welcome back, ${user.name}!</div>
      <p style="text-align:center;">You are now logged in. Ready to analyze some feedback?</p>
      ${domainSelectorHTML()}
      <p style="text-align:center;">You're all set to upload your files or view the metrics dashboard.</p>
      <button class="submit-btn" onclick="window.location.href='/upload'">Go to Upload Page</button>`;
    document.getElementById('domainSelect').onchange = e => localStorage.setItem('selectedDomain', e.target.value);
  }

  function showLogin() {
    mainContent.innerHTML = `
      <form id="loginForm" class="card" novalidate>
        <div class="greeting">Login to SentimentAI</div>
        <div class="error" id="loginError"></div>
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" required autocomplete="username" />
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" required autocomplete="current-password" />
        <button class="submit-btn" type="submit">Login</button>
        <button type="button" class="auth-toggle" id="toSignup">Don't have an account? Signup</button>
      </form>`;
    document.getElementById('toSignup').onclick = () => { mode = 'signup'; render(); };
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const res = await fetch("/api/login", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: e.target.loginEmail.value.trim(), password: e.target.loginPassword.value })
      });
      const data = await res.json();
      if (res.ok && data.success) {
        localStorage.setItem("user", JSON.stringify(data.user));
        render();
      } else {
        document.getElementById('loginError').textContent = data.error || 'Invalid credentials';
      }
    };
  }

  function showSignup() {
    mainContent.innerHTML = `
      <form id="signupForm" class="card" novalidate>
        <div class="greeting">Create Your Account</div><div class="error" id="signupError"></div>
        <div class="two-column">
          <div><label for="firstName">First Name</label><input type="text" id="firstName" required /></div>
          <div><label for="lastName">Last Name</label><input type="text" id="lastName" required /></div>
        </div>
        <label for="companyName">Company Name</label><input type="text" id="companyName" required />
        <label for="companyType">Industry</label><select id="companyType" required><option value="" disabled selected>Select Industry</option><option>Tech</option><option>Healthcare</option><option>Education</option><option>Retail</option><option>Finance</option><option>Other</option></select>
        <label for="companySize">Company Size</label><select id="companySize" required><option value="" disabled selected>Select Size</option><option>1–10</option><option>11–50</option><option>51–200</option><option>200+</option></select>
        <label for="role">Your Role</label><input type="text" id="role" placeholder="e.g., Manager, Developer" required />
        <label for="phone">Phone Number (Optional)</label><input type="tel" id="phone" />
        <label for="country">Country</label><input type="text" id="country" required />
        <label for="email">Email Address</label><input type="email" id="email" required />
        <label for="password">Password (min. 6 characters)</label><input type="password" id="password" minlength="6" required />
        <button class="submit-btn" type="submit">Create Account</button>
        <button type="button" class="auth-toggle" id="toLogin">Already have an account? Login</button>
      </form>`;
    document.getElementById('toLogin').onclick = () => { mode = 'login'; render(); };
    document.getElementById('signupForm').onsubmit = async (e) => {
      e.preventDefault();
      const formData = {
        firstName: e.target.firstName.value.trim(), lastName: e.target.lastName.value.trim(),
        company: e.target.companyName.value.trim(), companyType: e.target.companyType.value,
        companySize: e.target.companySize.value, role: e.target.role.value.trim(),
        phone: e.target.phone.value.trim(), country: e.target.country.value.trim(),
        email: e.target.email.value.trim(), password: e.target.password.value
      };
      const res = await fetch("/api/signup", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(formData) });
      const data = await res.json();
      if (res.ok && data.success) {
        localStorage.setItem("user", JSON.stringify(data.user));
        render();
      } else {
        document.getElementById('signupError').textContent = data.error || 'Signup failed.';
      }
    };
  }

  function render() {
    user = JSON.parse(localStorage.getItem('user'));
    if (isUserValid(user)) { mode = 'landing'; showLanding(); } 
    else if (mode === 'signup') { showSignup(); } 
    else { mode = 'login'; showLogin(); }
    updateProfileMenu();
  }

  render();
</script>
</body>
</html>

