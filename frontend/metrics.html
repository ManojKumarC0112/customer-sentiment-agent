<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SentimentAI Metrics Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg-dark: #1f2024;
    --nav-dark: #292a30;
    --text: #e0e0e0;
    --accent: #FF8800;
    --accent-hover: #cc6b00;
    --card-bg: #2e2f34;
  }
  [data-theme="light"] {
    --bg-dark: #f6f7f8;
    --nav-dark: #ecedef;
    --text: #222222;
    --card-bg: #fff;
    --accent: #cc6b00;
    --accent-hover: #ff8800;
  }
  body {
    margin: 0;
    background: var(--bg-dark);
    color: var(--text);
    font-family: 'Poppins', Arial, sans-serif;
    min-height: 100vh;
  }
  header {
    background: var(--nav-dark);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 2.5rem;
    height: 65px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.6);
    position: sticky;
    top: 0;
  }
  .brand-logo {
    font-weight: 900;
    font-size: 1.7rem;
    color: var(--accent);
    text-transform: uppercase;
    cursor: pointer;
    user-select: none;
    text-decoration: none;
  }
  nav {
    flex-grow: 1;
    margin-left: 3rem;
    display: flex;
    gap: 1.75rem;
    font-weight: 600;
    font-size: 1.05rem;
  }
  .nav-link {
    color: var(--text);
    text-decoration: none;
    user-select: none;
  }
  .nav-link:hover,
  .nav-link[aria-current="page"] {
    color: var(--accent);
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 1.1rem;
  }
  .quick-btn {
    background: var(--accent);
    color: #222;
    border: none;
    border-radius: 8px;
    padding: 0.5rem 1.25rem;
    font-weight: 700;
    cursor: pointer;
    font-size: 1rem;
    user-select: none;
  }
  .quick-btn:hover,
  .quick-btn:focus {
    background: var(--accent-hover);
    color: white;
  }
  .theme-toggle {
    background: var(--card-bg);
    border: 2px solid var(--accent);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    color: var(--accent);
    transition: background-color 0.3s ease, color 0.3s ease;
    user-select: none;
  }
  .theme-toggle:hover,
  .theme-toggle:focus {
    background: var(--accent);
    color: white;
  }
  main {
    max-width: 900px;
    margin: 4rem auto 2rem auto;
    padding: 0 1rem;
  }
  h1 {
    text-align: center;
    color: var(--accent);
    font-weight: 900;
    margin-bottom: 1rem;
  }
  .summary {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.1rem;
  }
  .charts-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    justify-content: center;
  }
  .chart-box {
    background: var(--nav-dark);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    width: 400px;
  }
  canvas {
    display: block;
    margin: 0 auto;
  }
  .back-home {
    display: block;
    margin: 0 auto 2rem auto;
    width: max-content;
    text-decoration: none;
    font-weight: 700;
    color: var(--accent);
    border: 2px solid var(--accent);
    padding: 0.4rem 1rem;
    border-radius: 12px;
    user-select: none;
  }
  .back-home:hover,
  .back-home:focus {
    background: var(--accent);
    color: var(--card-bg);
  }
  .loading {
    text-align: center;
    padding: 3rem;
    font-size: 1.2rem;
    color: var(--accent);
  }
</style>
</head>
<body data-theme="dark">
<header>
  <a href="index.html" class="brand-logo" aria-label="SentimentAI homepage">SentimentAI</a>
  <nav>
    <a href="index.html" class="nav-link">Home</a>
    <a href="upload.html" class="nav-link">Upload</a>
    <a href="about.html" class="nav-link">About</a>
    <a href="#" class="nav-link">Domain Settings</a>
  </nav>
  <div class="header-actions">
    <button class="quick-btn" title="Help">Help</button>
    <button class="theme-toggle" id="toggleTheme" aria-label="Toggle Dark/Light mode">üåô</button>
  </div>
</header>
<main>
  <a href="index.html" class="back-home" tabindex="0">‚Üê Back to Home</a>
  <h1>SentimentAI Feedback Metrics</h1>
  <div class="loading" id="loading">Loading analytics data...</div>
  <div id="contentArea" style="display: none;">
    <div class="summary" aria-live="polite" role="region">
      Total Feedback Responses: <strong id="totalResponses">0</strong><br />
      Urgency Levels Overview
    </div>
    <div class="charts-container" role="main">
      <section class="chart-box" aria-label="Urgency Levels Pie Chart">
        <canvas id="urgencyChart" width="400" height="400"></canvas>
      </section>
      <section class="chart-box" aria-label="Sentiment Distribution Bar Chart">
        <canvas id="sentimentChart" width="400" height="400"></canvas>
      </section>
    </div>
  </div>
</main>

<script>
  // Authentication check
  const user = JSON.parse(localStorage.getItem('user') || 'null');
  if (!user) {
    window.location.href = '/login';
  }

  // Theme toggle sync with localStorage
  const themeToggle = document.getElementById('toggleTheme');
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  themeToggle.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

  themeToggle.onclick = () => {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    themeToggle.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  };

  // Logout function
  function logout() {
    localStorage.removeItem('user');
    window.location.href = '/login';
  }
  window.logout = logout;

  // Fetch statistics from backend API
  async function loadStats() {
    try {
      const response = await fetch('/api/stats');
      const data = await response.json();

      if (data.success) {
        const stats = data.stats;

        // Hide loading, show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('contentArea').style.display = 'block';

        // Update total responses
        document.getElementById('totalResponses').textContent = stats.total || 0;

        // Prepare urgency and sentiment data
        const urgencyCounts = {
          'High': stats.urgency.high || 0,
          'Medium': stats.urgency.medium || 0,
          'Low': stats.urgency.low || 0
        };

        const sentimentCounts = {
          'Positive': stats.sentiment.positive || 0,
          'Neutral': stats.sentiment.neutral || 0,
          'Negative': stats.sentiment.negative || 0
        };

        // Create urgency pie chart
        const urgencyCtx = document.getElementById('urgencyChart').getContext('2d');
        new Chart(urgencyCtx, {
          type: 'pie',
          data: {
            labels: Object.keys(urgencyCounts),
            datasets: [{
              data: Object.values(urgencyCounts),
              backgroundColor: [
                '#E57373', // High (Red)
                '#FFB74D', // Medium (Orange)
                '#81C784'  // Low (Green)
              ],
              borderColor: getComputedStyle(document.body).getPropertyValue('--nav-dark'),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: getComputedStyle(document.body).getPropertyValue('--text')
                }
              },
              title: {
                display: true,
                text: 'Urgency Levels',
                color: getComputedStyle(document.body).getPropertyValue('--accent'),
                font: { size: 18, weight: 'bold' }
              }
            }
          }
        });

        // Create sentiment bar chart
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
        new Chart(sentimentCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(sentimentCounts),
            datasets: [{
              label: 'Number of Responses',
              data: Object.values(sentimentCounts),
              backgroundColor: [
                '#66BB6A', // Positive (Green)
                '#FFB74D', // Neutral (Orange)
                '#E57373'  // Negative (Red)
              ],
              borderWidth: 1,
              borderColor: getComputedStyle(document.body).getPropertyValue('--nav-dark')
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: getComputedStyle(document.body).getPropertyValue('--text')
                }
              },
              x: {
                ticks: {
                  color: getComputedStyle(document.body).getPropertyValue('--text')
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: getComputedStyle(document.body).getPropertyValue('--text')
                }
              },
              title: {
                display: true,
                text: 'Feedback Sentiment Distribution',
                color: getComputedStyle(document.body).getPropertyValue('--accent'),
                font: { size: 18, weight: 'bold' }
              }
            }
          }
        });

        console.log('Stats loaded successfully:', stats);
      } else {
        document.getElementById('loading').textContent = 'Error loading data: ' + (data.error || 'Unknown error');
      }
    } catch (error) {
      console.error('Error loading stats:', error);
      document.getElementById('loading').textContent = 'Failed to load analytics. Please check if backend is running.';
    }
  }

  // Load stats when page loads
  window.addEventListener('DOMContentLoaded', loadStats);
</script>
</body>
</html>
